<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DFRP Wildfire Simulator v1.5 - Chinook Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #eef0f5; font-family: 'Segoe UI', sans-serif; }
        
        /* --- SPLASH SCREEN --- */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        .splash-content { text-align: center; color: white; animation: fadeIn 1.5s ease-out; }
        .splash-content h1 { font-size: 3.5rem; margin-bottom: 10px; letter-spacing: 2px; }
        #startAppBtn {
            padding: 15px 50px; font-size: 18px; font-weight: bold; text-transform: uppercase;
            background: #d32f2f; color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(211, 47, 47, 0.6); transition: 0.2s;
        }
        #startAppBtn:hover { background: #b71c1c; transform: scale(1.05); }

        /* --- UI --- */
        #ui {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 255, 255, 0.95); color: #333;
            padding: 15px; border-radius: 8px; border: 1px solid #ccc;
            width: 290px; user-select: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 10; transition: transform 0.5s, opacity 0.5s;
        }
        .ui-hidden { transform: translateX(-320px); opacity: 0; }
        .control { margin-bottom: 15px; }
        label { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #666; font-weight: bold; }
        input[type=range] { width: 100%; accent-color: #d32f2f; }
        .val { color: #d32f2f; font-weight: 700; }

        /* --- TOOLBAR --- */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: white; padding: 12px 25px;
            border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 100; align-items: center;
        }
        .tool {
            width: 54px; height: 54px; border-radius: 50%; border: 2px solid #eee;
            background: white; cursor: pointer; font-size: 24px; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .tool:hover { transform: scale(1.1); }
        .tool.active { border-color: #d32f2f; background: #fff0f0; }
        .tool.active-heli { border-color: #0077be; background: #e0f0ff; }
        
        .data-readout { display: flex; flex-direction: column; align-items: center; min-width: 80px; padding: 0 10px; }
        .data-label { font-size: 9px; text-transform: uppercase; color: #999; font-weight: 800; }
        .data-val { font-size: 16px; font-weight: 700; }

        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #eef0f5; display: flex; justify-content: center; align-items: center; z-index: 999; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>

<div id="splashScreen">
    <div class="splash-content">
        <h1>DFRP WILDFIRE SIM</h1>
        <p>Chinook Air-Support Update v1.6</p>
        <button id="startAppBtn">Load Up & Start</button>
    </div>
</div>

<div id="loading">Generating Environment...</div>

<div id="ui" class="ui-hidden">
    <h3>Simulation Controls</h3>
    <div class="control">
        <label>Wind Heading <span id="windDirVal" class="val">0¬∞</span></label>
        <input type="range" id="windDir" min="0" max="360" value="0">
    </div>
    <div class="control">
        <label>Wind Speed <span id="windSpeedVal" class="val">25</span></label>
        <input type="range" id="windSpeed" min="0" max="80" value="25">
    </div>
    <div class="control">
        <label>Fuel Moisture <span id="moistureVal" class="val">15%</span></label>
        <input type="range" id="moisture" min="5" max="30" value="15">
    </div>
    <button id="resetBtn" style="width:100%; padding:10px; cursor:pointer;">Regenerate Terrain</button>
</div>

<div id="toolbar">
    <div class="tool" id="toolIgnite" title="Ignite Fire">üî•</div>
    <div class="tool" id="toolCut" title="Firebreak">ü™ì</div>
    <div class="tool" id="toolHeli" title="Chinook Water Drop">üöÅ</div>
    
    <div class="data-readout">
        <span class="data-label">Time</span>
        <span class="data-val" id="timeDisplay">10:00 AM</span>
    </div>
    <div class="data-readout">
        <span class="data-label">Acres</span>
        <span class="data-val" id="acresDisplay">0.0</span>
    </div>
</div>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const CONFIG = {
        count: 100000, worldSize: 1500, cellSize: 20,
        baseSpreadRate: 0.05, dryingRate: 0.07, acreageConstant: 0.012 
    };

    const S_LIVE = 0, S_DRYING = 1, S_BURNING = 2, S_CHARRED = 3, S_CUT = 4;
    const FUEL_PROPS = {
        0: { spread: 2.5, burn: 0.4, scaleY: 0.15, col: 0x7cfc00 }, // Grass
        1: { spread: 1.0, burn: 1.0, scaleY: 0.6, col: 0x556b2f },  // Brush
        2: { spread: 0.4, burn: 3.5, scaleY: 2.2, col: 0x004d00 }   // Timber
    };

    let scene, camera, renderer, controls, mesh, ground, heliGroup, waterSystem;
    let currentTool = null;
    let acresBurned = 0;
    let simMinutes = 600;
    const STRIDE = 8;
    let data = new Float32Array(CONFIG.count * STRIDE);
    let windVec = { x: 0, z: -1 }, windSpeed = 25, baseMoisture = 15;
    let heliActive = false, heliTarget = new THREE.Vector3();

    function getElevation(x, z) { return Math.sin(x*0.005)*30 + Math.cos(z*0.004)*30; }

    function initScene() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(35, window.innerWidth/window.innerHeight, 0.1, 15000);
        camera.position.set(-600, 450, 1100);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        const sun = new THREE.DirectionalLight(0xffffff, 1.4);
        sun.position.set(500, 1000, 500);
        scene.add(sun, new THREE.AmbientLight(0xffffff, 0.4));

        // Ground
        ground = new THREE.Mesh(new THREE.PlaneGeometry(1800, 1800, 100, 100), new THREE.MeshStandardMaterial({ color: 0x556b2f }));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        // Instanced Fuel
        mesh = new THREE.InstancedMesh(new THREE.DodecahedronGeometry(2, 0), new THREE.MeshStandardMaterial({ color: 0xffffff }), CONFIG.count);
        scene.add(mesh);

        // --- CHINOOK ASSET ---
        heliGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(15, 5, 5), new THREE.MeshStandardMaterial({color: 0x2d3436}));
        const r1 = new THREE.Mesh(new THREE.BoxGeometry(22, 0.2, 1), new THREE.MeshStandardMaterial({color: 0x000}));
        const r2 = r1.clone();
        r1.position.set(-6, 3.5, 0); r2.position.set(6, 3.5, 0);
        heliGroup.add(body, r1, r2);
        heliGroup.rotors = [r1, r2];
        heliGroup.visible = false;
        scene.add(heliGroup);

        // Water Particles
        const pGeo = new THREE.BufferGeometry();
        pGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(300 * 3), 3));
        waterSystem = new THREE.Points(pGeo, new THREE.PointsMaterial({color: 0x00a8ff, size: 2}));
        waterSystem.visible = false;
        scene.add(waterSystem);
    }

    function initSim() {
        for(let i=0; i<CONFIG.count; i++) {
            const idx = i * STRIDE;
            const x = (Math.random()-0.5) * CONFIG.worldSize;
            const z = (Math.random()-0.5) * CONFIG.worldSize;
            const type = Math.floor(Math.random()*3);
            data[idx] = x; data[idx+1] = z; data[idx+2] = S_LIVE; 
            data[idx+3] = baseMoisture * 10; data[idx+4] = 100 * FUEL_PROPS[type].burn;
            data[idx+6] = getElevation(x, z); data[idx+7] = type;
            
            const mat = new THREE.Matrix4().makeTranslation(x, data[idx+6], z);
            mesh.setMatrixAt(i, mat);
            mesh.setColorAt(i, new THREE.Color(FUEL_PROPS[type].col));
        }
        mesh.instanceMatrix.needsUpdate = true;
        mesh.instanceColor.needsUpdate = true;
        document.getElementById('loading').style.display = 'none';
    }

    function dispatchHeli(target) {
        if(heliActive) return;
        heliActive = true;
        heliTarget.copy(target);
        heliGroup.position.set(target.x - 500, 180, target.z);
        heliGroup.visible = true;
    }

    function updateHeli() {
        if(!heliActive) return;
        heliGroup.position.x += 4;
        heliGroup.rotors.forEach(r => r.rotation.y += 0.4);

        const dist = Math.abs(heliGroup.position.x - heliTarget.x);
        if(dist < 10) {
            waterSystem.visible = true;
            const pos = waterSystem.geometry.attributes.position.array;
            for(let i=0; i<300; i++) {
                pos[i*3] = heliGroup.position.x + (Math.random()-0.5)*20;
                pos[i*3+1] = heliGroup.position.y - (Math.random()*40);
                pos[i*3+2] = heliGroup.position.z + (Math.random()-0.5)*20;
            }
            waterSystem.geometry.attributes.position.needsUpdate = true;
            
            // Extinguish Logic
            for(let i=0; i<CONFIG.count; i++) {
                const idx = i*STRIDE;
                const dSq = Math.pow(data[idx]-heliTarget.x, 2) + Math.pow(data[idx+1]-heliTarget.z, 2);
                if(dSq < 2500) {
                    data[idx+2] = S_LIVE; data[idx+3] = 200; // Wet
                    mesh.setColorAt(i, new THREE.Color(0x0066cc));
                }
            }
            mesh.instanceColor.needsUpdate = true;
        }

        if(heliGroup.position.x > heliTarget.x + 600) {
            heliActive = false; heliGroup.visible = false; waterSystem.visible = false;
        }
    }

    function updatePhysics() {
        simMinutes += 0.05;
        const h = Math.floor(simMinutes/60)%24, m = Math.floor(simMinutes%60);
        document.getElementById('timeDisplay').textContent = `${h%12||12}:${m<10?'0':''}${m} ${h>=12?'PM':'AM'}`;
        document.getElementById('acresDisplay').textContent = acresBurned.toFixed(1);

        for(let i=0; i<CONFIG.count; i++) {
            const idx = i*STRIDE;
            if(data[idx+2] === S_BURNING) {
                data[idx+4] -= 0.5;
                if(data[idx+4] <= 0) {
                    data[idx+2] = S_CHARRED;
                    acresBurned += CONFIG.acreageConstant;
                    mesh.setColorAt(i, new THREE.Color(0x111111));
                    mesh.instanceColor.needsUpdate = true;
                }
                // Very basic spread logic for demo
                if(Math.random() > 0.98) {
                    const neighborIdx = Math.floor(Math.random()*CONFIG.count)*STRIDE;
                    if(data[neighborIdx+2] === S_LIVE) data[neighborIdx+2] = S_BURNING;
                }
            }
        }
    }

    const raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();
    window.addEventListener('mousedown', e => {
        mouse.x = (e.clientX/window.innerWidth)*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObject(ground);
        if(hits.length > 0) {
            const pt = hits[0].point;
            if(currentTool === 'ignite') {
                for(let i=0; i<CONFIG.count; i++) {
                    const idx = i*STRIDE;
                    if(Math.pow(data[idx]-pt.x, 2) + Math.pow(data[idx+1]-pt.z, 2) < 400) data[idx+2] = S_BURNING;
                }
            } else if(currentTool === 'heli') dispatchHeli(pt);
        }
    });

    // --- BUTTONS ---
    document.getElementById('startAppBtn').onclick = () => {
        document.getElementById('splashScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('ui').classList.remove('ui-hidden');
        }, 800);
    };

    document.getElementById('toolIgnite').onclick = function() {
        currentTool = 'ignite';
        this.classList.add('active');
        document.getElementById('toolHeli').classList.remove('active-heli');
    };
    document.getElementById('toolHeli').onclick = function() {
        currentTool = 'heli';
        this.classList.add('active-heli');
        document.getElementById('toolIgnite').classList.remove('active');
    };

    initScene();
    initSim();

    function animate() {
        requestAnimationFrame(animate);
        updatePhysics();
        updateHeli();
        controls.update();
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>
